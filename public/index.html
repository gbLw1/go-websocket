<!doctype html>
<html lang="en">
  <head>
    <title>Websocket Go</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <div class="container" v-if="!connected">
        <form class="form" @submit.prevent="connect">
          <input
            v-model="nickname"
            autofocus
            class="input"
            type="text"
            placeholder="nickname"
          />
          <button type="submit" class="button">Join</button>
        </form>
      </div>

      <div class="client-pannel" v-if="connected">
        <label>Connected clients</label>
        <ul>
          <li v-for="(client, i) in clients" :key="i">{{client.Nickname}}</li>
        </ul>
      </div>

      <div class="container" v-if="connected">
        <p>
          Hello, <strong>{{nickname}}</strong> &nbsp;
          <a class="disconnect-link" href="#" @click="disconnect">Disconnect</a>
        </p>

        <ul class="chat-messages">
          <li
            v-for="(msg, i) in messages"
            :key="i"
            class="message"
            :class="[msg.from == this.nickname ? 'message-right': '']"
          >
            <!-- Avatar left side (receiver) -->
            <div
              v-if="msg.from != this.nickname"
              :title="msg.from"
              class="message-avatar"
              :class="[msg.from == 'SERVER' ? 'server-avatar': '']"
            >
              {{msg.from.toUpperCase().includes('GUEST') ? '??' :
              msg.from.slice(0, 2).toUpperCase()}}
            </div>

            <div class="message-content">
              <p
                class="message-nickname"
                :style="[msg.from == 'SERVER' ? 'color: #0096ff!important' : '']"
              >
                {{msg.from}}
              </p>
              <p class="message-text">{{msg.content}}</p>
              <p class="message-timestamp">{{msg.sentAt}}</p>
            </div>

            <!-- Avatar right side (sender) -->
            <div
              v-if="msg.from == this.nickname"
              :title="msg.from"
              class="message-avatar"
            >
              {{msg.from.toUpperCase().includes('GUEST') ? '??' :
              msg.from.slice(0, 2).toUpperCase()}}
            </div>
          </li>
        </ul>

        <form class="form" @submit.prevent="sendMessage">
          <input
            v-model="message"
            class="input"
            type="text"
            placeholder="message"
          />
          <button class="button" type="submit">Send</button>
        </form>
      </div>
    </div>

    <script>
      const { createApp, ref } = Vue;

      createApp({
        data() {
          return {
            nickname: "",
            connected: false,
            ws: null,
            message: "",
            messages: [],
            clients: [],
          };
        },
        methods: {
          sendMessage() {
            const msg = {
              from: this.nickname,
              content: this.message,
            };
            this.ws.send(JSON.stringify(msg));
            this.message = "";

            const chatMessages = document.querySelector(".chat-messages");
            chatMessages.addEventListener("DOMSubtreeModified", () => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            });
          },

          onOpen(event) {
            this.connected = true;
          },

          onMessage(event) {
            const data = JSON.parse(event.data);
            this.messages.push(data);

            if (this.messages.length > 50) {
              this.messages.shift();
            }

            this.updateConnectedClients();
          },

          connect() {
            if (!this.nickname) {
              this.nickname = `Guest${Math.floor(Math.random() * 1000)}`;
            }

            if (this.nickname.toUpperCase() === "SERVER") {
              alert("Nickname is not allowed");
              return;
            }

            this.ws = new WebSocket(
              `ws://localhost:1337/ws?nickname=${this.nickname}`,
            );
            this.ws.onopen = this.onOpen;
            this.ws.onmessage = this.onMessage;
          },

          disconnect() {
            this.ws.close();
            this.connected = false;
            this.ws = null;
            this.message = "";
            this.messages = [];
            this.clients = [];
          },
          async updateConnectedClients() {
            try {
              const res = await fetch("http://localhost:1337/clients");
              const data = await res.json();
              this.clients = data;
            } catch (error) {
              console.log(error);
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
